<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
    <th:block sec:authorize="isAuthenticated()">
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    </th:block>
</head>

<th:block layout:fragment="css">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
    <style>

        .write-wrap {
            margin: 1rem;
        }

        .write-wrap .title {

            /* width: calc(100% - 2rem); */
            width: 100%;
            box-sizing: border-box;

            padding: 2rem;
            margin-bottom: 1rem;
            /* margin-left: 1rem;
            margin-right: 1rem; */
        }

        .write-wrap .content {

            width: 100%;
            height: 20rem;
            box-sizing: border-box;

            padding: 2rem;
            font-size: 1em;
        }

        .button-wrap {
            display: flex;
        }

    </style>
</th:block>


<div layout:fragment="content">

    <div class="write-wrap">
        <input id="title" class=title type="text" name="title" placeholder="제목을 입력해주세요.">
        <div id="editor" class="content">
    </div>

    <div class="button-wrap">
        <button id="revert" class="btn btn-outline-dark">불러오기</button>
        <button id="save" class="btn btn-outline-dark">임시저장</button>        
        <button id="submit" class="btn btn-outline-dark">등록</button>
    </div>

</div>


<th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script th:inline="javascript">

        const quill = new Quill('#editor', {
           theme: 'snow'
         });
        

        document.getElementById("revert").addEventListener("click", async () => {

            if (window.confirm("임시저장된 내용을 불러오시겠습니까?\n(현재 작성중인 내용은 삭제됩니다.)")) {

                const title = localStorage.getItem("title");
                if (title) {
                    document.getElementById("title").value = title;
                }
                const content = localStorage.getItem("content");
                if (content) {
                    quill.root.innerHTML = content;
                }           
            }            
        });

        document.getElementById("save").addEventListener("click", async () => {
            
            const data = {
                title: document.getElementById("title").value.trim(),
                content: quill.root.innerHTML
            };

            localStorage.setItem("title", data.title);
            localStorage.setItem("content", data.content);
        });


        document.getElementById("submit").addEventListener("click", async () => {

            var header = $("meta[name='_csrf_header']").attr("content");
            var token = $("meta[name='_csrf']").attr("content");

        const data = {
            title: document.getElementById("title").value.trim(),
            content: quill.root.innerHTML
        };

        if (!data.title || !data.content) {
            alert("제목과 내용을 모두 입력해주세요.");
            return;
        }

        // 버튼 비활성화 (중복 전송 방지)
        const btn = document.getElementById("submit");
        btn.disabled = true;
        btn.textContent = "전송 중...";

        localStorage.setItem("title", data.title);
        localStorage.setItem("content", data.content);

        try {
            const res = await fetch("/board/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [header]: token
                  },
                body: JSON.stringify(data)
            });

            if (!res.ok) {
                throw new Error("서버 오류");
            }else{

            }

            localStorage.removeItem("title");
            localStorage.removeItem("content");

            location.href='/';

        } catch (err) {
            alert("서버 응답이 없습니다.");
        } finally {
            btn.disabled = false;
            btn.textContent = "전송";
        }
    });

    const errors = [[${errors}]]
    console.log(errors)

    let errorMsg = ''

    if(errors){
        for (let i = 0; i < errors.length; i++) {
        errorMsg += `${errors[i].field}은(는) ${errors[i].code} \n`
        }
        alert(errorMsg)
    }
    </script>
</th:block>